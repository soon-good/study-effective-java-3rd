# 8.3 ThreadPoolExecutor 설정

큐에 쌓인 작업 관리, corePoolSize, maxPoolSize의 의미, 기본으로 제공되는 팩토리 메서드 들의 단점, 직접 구현할경우에 대한 이야기 등 중요한 내용들이 많다. 이 외에 '집중대응 정책' 등 중요한 내용도 많기에 이번 내용도 정성껏 정리해야 한다.<br>

이번 절을 읽으면서 의외였던 점이 있었다. 바로 `newCachedThreadPool` 팩토리 메서드에 대한 내용이다. `effective java` 에서는 `newCachedThreadPool` 에 대해 부주의하게 사용하는 것에 대해 경고를 하지만, `자바 병렬 프로그래밍` 에서는 `newCachedThreadPool` 을 올바로 사용하는 방식과 사용하면 좋은 경우를 설명하고 있다.<br>

<br>

## ThreadPoolExecutor

ThreadPoolExecutor 는 Executor 클래스의 `newCachedThreadPool`, `newFixedThreadPool`, `newScheduledThreadPool` 등의 팩토리 메서드로 객체를 생성 가능하다. 또는 커스터마이징된 설정을 적용한 클래스에서 ThreadPoolExecutor 객체를 생성할 수도 있다. ThreadPoolExecutor 는 Executor 타입의 클래스이다. <br>

`newCachedThreadPool`, `newFixedThreadPool`, `newScheduledThreadPool` 팩토리 메서드에서 생성하는 ThreadPoolExecutor 객체는 Executor 객체를 생성할 때 자주 설정하는 유형들을 정형화해서 자바 플랫폼 내에서 미리 제공하는 팩토리 메서드다. 따라서 `newCachedThreadPool`, `newFixedThreadPool`, `newScheduledThreadPool`  팩토리 메서드가 완전히 만능은 아니고, 실무에서 직접 뭔가 더 세분화된 작업을 하려면 어느 정도는 커스터마이징을 거쳐야 한다.<br>

<br>

## 8.3.1 스레드 생성과 제거

아래는 `ThreadPoolExcuotr` 클래스의 생성자다. pool 의 core 크기, 최대(maximum) 크기, 스레드 유지(keep-alive) 시간 등의 값을 통해 스레드가 생성되고 제거되는 과정을 조절하는 것이 가능하다.

`corePoolSize` (코어 크기) 와 `keepAliveTime` (스레드 유지 시간) 을 적절하게 조절하면 작업 없이 쉬고 있는 스레드가 차지하고 있는 자원을 프로그램의 다른 부분에서 활용하게끔 반납하도록 할 수 있다. 

스레드를 한번 종료하고 나서, 나중에 스레드가 필요해서 새로 생성할 때 일정 시간이 소요된다는 점을 감안해 스레드 풀의 크기를 설정해야 한다. 

```java
public ThreadPoolExecutor (
    int corePoolSize, int maximumPoolSize,
    long keepAliveTime, TimeUnit unit,
    BlockingQueue<Runnable> workQueue,
    ThreadFactory threadFactory,
    RejectedExecutionHandler handler
){
    // ...
}
```

<br>

- `corePoolSize`
  - 스레드 풀을 사용할 때 원하는 스레드의 갯수
  - 스레드 풀 클래스는 실행할 작업이 없어도 스레드의 갯수를 최대한 코어 크기에 맞추도록 되어 있다.
  - 큐에 작업이 가득 차지 않는 이상 스레드의 수가 코어 크기를 넘지 않는다.
  - `ThreadPoolExecutor` 를 생성한 이후에도 `prestartAllCoreThreads` 메서드를 호출하지 않는 한 코어 크기만큼의 스레드가 미리 만들어지지는 않는다.
  - 작업이 실행되면서 코어 크기까지의 스레드가 차례로 생성된다.
- `maximumPoolSize`
  - 동시에 얼마나 많은 갯수의 스레드가 동작할 수 있는지를 제한하는 최댓값
  - 지정한 스레드 유지 시간 이상 아무런 작업 없이 대기하는 스레드는 제거 대상 목록에 올라간다.
  - 풀의 스레드 갯수가 코어 크기를 넘어서면 제거될 수 있다.

<br>

**`corePoolSize` 를 사용할때의 주의점**<br>

자바 플랫폼 라이브러리를 사용하는 사용자인 개발자 입장에서는 풀의 코어 크기(`corePoolSize`)를 0으로 맞춰서 작업이 없을 경우는 스레드가 모두 사라지게끔 하려고 의도할 수 있다. 하지만 이렇게 풀의 `corePoolSize` 를 0으로 잡으면 굉장히 이상한 현상이 발생할 수 있다. 

`newCachedThreadPool`팩토리 메서드로 생성하는 스레드 풀은 SynchronousQueue 를 사용한다. 하지만, SynchronousQueue를 사용하지 않는 다른 스레드 풀의 경우는 이상한 현상이 발생할 가능성이 있다.

(이 부분은 무슨 말인지 잘 이해가 안된다. 나중에 다시 확인해봐야 함)ThreadPoolExecutor 는 풀의 스레드 갯수가 코어 크기(`corePoolSize`)에 다다르고 그와 동시에 작업 큐가 가득찬 경우에만 새로운 스레드를 생성한다. 따라서 코어 크기(`corePoolSize`)가 0보다 크고 크기가 제한되지 않은 큐를 사용하는 스레드 풀에서는 등록된 작업이 제대로 실행되지 못한다.<br>

<br>

**`allowCoreThreadTimeout` 메서드**<br>

풀 내부의 모든 스레드가 시간 제한에 걸리도록 하는 메서드다. 특정 크기의 스레드와 크기가 제한된 작업 큐를 사용하는 스레드 풀에서 `allowCoreThreadTimeout ` 기능을 활용하는 동시에 코어크기(`corePoolSize`) 를 0보다 큰 값으로 지정하면 처리할 작업이 없을 때 스레드가 점차 사라지도록 해 원하는 결과를 얻을 수 있다.<br>

<br>

### newFixedThreadPool 팩토리 메서드

스레드 풀의 `corePoolSize` 와 `maximumPoolSize` 를 newFixedThreadPool 메서드에 지정한 값으로 값으로 똑같이 지정해준다. 즉, 예를 들면 newFixedThreadPool 메서드에 5 라는 값을 넘겨주면, `corePoolSize` , `maximumPoolSize` 는 5 로 세팅된다. 시간은 무제한으로 설정되는 효과를 갖는다.

<br>

### newCachedThreadPool 팩토리 메서드

스레드 풀의 최대 크기(`maximumPoolSize`) 를 `Integer.MAX_VALUE` 값으로 지정하고 코어 크기(`corePoolSize` )를 0으로 지정한다. 그리고 스레드 유지 시간(`keepAliveTime`)을 1분으로 지정한다.<br>

따라서 `newCachedThreadPool`에서 만들어내는 스레드 풀은 끝없이 크기가 늘어날 수 있고, 사용량이 줄어들면 스레드 갯수가 적당히 줄어드는 효과가 있다. 책에서는 이렇게 이야기하고 있고, 공식문서에서도 별다른 이야기는 없더라도...당연하게도 사이드 이펙트가 있는지 역시도 테스트 시에 체크해봐야 한다.<br>

<br>

### ThreadPoolExecutor 생성자를 직접 사용

`ThreadPoolExecutor` 클래스의 생성자 메서드를 직접 호출해서 `corePoolSize`, `maximumPoolSize` , `keepAliveTime` 을 커스터마이징해서 다양한 조합을 만들어내는 것 역시도 가능하다.<br>

<br>














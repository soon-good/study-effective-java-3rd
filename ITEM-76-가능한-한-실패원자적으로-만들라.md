# ITEM 76 - 가능한 한 실패원자적으로 만들라

실패 원자적(`failure-atomic`)<br>

호출된 메서드가 실패하더라도 해당 객체는 메서드 호출전 상태를 유지해야 한다. 이런 특직을 실패 원자적이라고 이야기 한다. 예를 들면 작업 도중 예외가 발생해도 그 객체는 여전히 정상적으로 사용할 수 있는 상태가 되는 경우를 예로 들 수 있다.<br>

<br>

## 메서드를 실패원자적으로 만드는 방법들

메서드를 실패원자적으로 만드는 방법은 4가지가 있다.

- 불변객체
- 매개변수 유효성 체크
  - 실패 가능성 높은 코드를 객체상태를 바꾸는 코드보다 앞에 배치
- 객체 복사본으로 작업
- 작업도중의 실패를 가로채는 복구 코드를 작성. 작업 이전으로 돌릴 수 있는 방법을 제공

<br>

### 1 ) 불변객체

불변객체는 태생적으로 실패원자적이다. 메서드가 실패하면, 새로운 객체가 만들어지지 않을 수 있지만, 기존 객체가 불안정한 상태에서 계속 프로그램이 수행되지는 않는다.<br>

<br>

### 2 ) 매개변수 유효성 체크

**매개변수의 유효성 체크**<br>

가변객체의 메서드의 경우 상태가 변하는 변수를 사용한다. 이런 경우, 작업 수행에 앞서 매개변수의 유효성을 체크하는 방식으로 실패원자성을 확보할 수 있다. 이렇게 하면 객체 내부 상태를 변경하기에 앞서 잠재적으로 예외가 발생할 수 있는 대부분의 가능성을 미리 차단하게 된다. <br>

<br>

```java
public Object pop(){
    if(size == 0){
        throw new EmptyStackException();
    }
    Object result = elements[--size];
    elements[size] = null;
    return result;
}
```

위 코드의 경우 스택에 더 이상 요소가 없을 경우에 pop 을 하면, `EmptyStackException` 을 발생시키는 것이 더 적절하다. 만약 메서드의 초입부에 size를 체크하는 부분이 없었다면, `ArrayIndexOutOfBuondsException` 이 발생하는데, 이렇게 되면, 예외의 원인을 파악하기에 조금 더 어려웠을수도 있다.<br>

<br>

**실패 가능성 높은 코드는 객체의 상태를 바꾸는 코드보다 앞에 배치**<br>

가능한 실패 가능성 높은 코드는 객체 상태를 바꾸는 코드보다 앞에 배치하는 것도 좋은 방법이다.

ex) `TreeMap` <br>

- TreeMap 에 원소를 추가하려 할때, TreeMap 을 업데이트하기에 앞서 비교가 불가능한 타입의 원소일 경우 `ClassCastException`을 발생시킨다.<br>

<br>

### 3 ) 객체의 복사본으로 작업

작업을 수행시에 객체의 임시복사본으로 작업하고 작업이 성공적으로 완료되면 원래 객체와 교체하는 방식.<br>

데이터를 임시 자료구조에 저장해서 작업하는 것이 더 빠를때 사용하는 방식이다. <br>

내 경우는, 병렬 프로그래밍을 구현할때 동시수정을 방지하고, 객체의 불변성을 확보하기 위해 이런 방식을 사용했었다.<br>

<br>

### 4 ) 복구 코드 구현

작업 도중 작업이 실패할 경우 실패를 가로채어 작업 전 상태로 되돌리는 메서드를 구현하는 방식이다. 주로 디스크 기반의 내구성, `durability` 를 확보해야 하는 자료구조에 쓰이는 편이다.<br>

<br>

## 자바 API

>참고) 모든 자바의 API가 실패원자적으로 되어있지는 않다. 실패원자적이지 않다면, 실패시의 객체 상태가 API 설명에 명시되어야 하는데, 현재는 그렇지 않은 경우가 더 많다.<br>

<br>

실패 원자적으로 무조건적으로 코드를 구성해야 하는 것은 아니다. 하지만, 메서드 명세에 기술된 예외라면 설령 예외가 발생하더라도 객체의 상태는 메서드 호출 전과 똑같이 유지해야 하는 것이 기본 원칙이다.<br>

이 규칙이 지켜지기 어렵다면, 실패 시의 객체 상태를 API 설명에 명시해야 한다. 이것이 이상적이나, 아쉽게도 지금의 API 문서 상당 부분이 지켜지지 않고 있다.<br>

<br>

















